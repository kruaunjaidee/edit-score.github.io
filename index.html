<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการข้อมูลแว่นตา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        #modal { display: none; }
        #modal:not(.hidden) { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            z-index: 1000; 
        }
        #modal .modal-content { 
            max-height: 80vh; 
            overflow-y: auto; 
            width: 100%; 
            max-width: 1000px; /* Increased for better form layout */
            margin: 1rem; /* Ensure margin on small screens */
        }
        #preloader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: white; 
            z-index: 9999; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .checkbox-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 1rem; 
        }
        .checkbox-group label { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="preloader">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold text-center mb-6 text-blue-600">ระบบจัดการข้อมูลแว่นตา</h1>
        
        <button id="openModalBtn" class="mb-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
            เพิ่มข้อมูลลูกค้า
        </button>

        <!-- Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
            <div class="modal-content bg-white p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-4">บันทึกข้อมูลลูกค้า</h2>
                <form id="customerForm">
                    <!-- Customer Information -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">ข้อมูลสมาชิก</h3>
                        <div class="checkbox-group">
                            <label><input type="radio" name="member_type" value="member"> ลูกค้าสมาชิก</label>
                            <label><input type="radio" name="member_type" value="new"> ลูกค้าใหม่</label>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">ข้อมูลลูกค้า</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">วันเดือนปี</label>
                                <input type="text" id="birth_date" class="flatpickr w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">ชื่อ</label>
                                <input type="text" name="first_name" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">สกุล</label>
                                <input type="text" name="last_name" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">อายุ</label>
                                <input type="number" name="age" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">เพศ</label>
                                <select name="gender" class="w-full p-2 border rounded" required>
                                    <option value="male">ชาย</option>
                                    <option value="female">หญิง</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">หมายเลขโทรศัพท์</label>
                                <input type="tel" name="phone" class="w-full p-2 border rounded" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium">ที่อยู่</label>
                                <textarea name="address" class="w-full p-2 border rounded" rows="4" required></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- O.D[R] and O.D[L] -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-semibold mb-2">O.D[R]</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm">Sphere</label><input type="text" name="od_r_sphere" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">CYL</label><input type="text" name="od_r_cyl" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">AXIS</label><input type="text" name="od_r_axis" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">ADD</label><input type="text" name="od_r_add" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">DPD</label><input type="text" name="od_r_dpd" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">NPD</label><input type="text" name="od_r_npd" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">SegHT</label><input type="text" name="od_r_seght" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">Prism</label><input type="text" name="od_r_prism" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">MONO-VA</label><input type="text" name="od_r_mono_va" class="w-full p-2 border rounded"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-2">O.D[L]</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm">Sphere</label><input type="text" name="od_l_sphere" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">CYL</label><input type="text" name="od_l_cyl" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">AXIS</label><input type="text" name="od_l_axis" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">ADD</label><input type="text" name="od_l_add" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">DPD</label><input type="text" name="od_l_dpd" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">NPD</label><input type="text" name="od_l_npd" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">SegHT</label><input type="text" name="od_l_seght" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">Prism</label><input type="text" name="od_l_prism" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">MONO-VA</label><input type="text" name="od_l_mono_va" class="w-full p-2 border rounded"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Lens Information -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">ข้อมูลเลนส์</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm">VA Both eyes (OU)</label><input type="text" name="va_both_eyes" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">เลนส์เดิม R</label><input type="text" name="lens_old_r" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">เลนส์เดิม L</label><input type="text" name="lens_old_l" class="w-full p-2 border rounded"></div>
                        </div>
                    </div>

                    <!-- Primary Rx -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">Primary Rx</h3>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">Material Index</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="material_index" value="CR39"> CR39</label>
                                <label><input type="checkbox" name="material_index" value="1.56"> 1.56</label>
                                <label><input type="checkbox" name="material_index" value="1.6"> 1.6</label>
                                <label><input type="checkbox" name="material_index" value="1.67"> 1.67</label>
                                <label><input type="checkbox" name="material_index" value="1.74"> 1.74</label>
                                <label><input type="checkbox" name="material_index" value="PC"> PC</label>
                                <label><input type="checkbox" name="material_index" value="HIVEX"> HIVEX</label>
                                <label><input type="checkbox" name="material_index" value="Other"> Other</label>
                                <input type="text" name="material_index_other" class="w-full p-2 border rounded" placeholder="ระบุอื่นๆ">
                            </div>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">Option</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="lens_option" value="Clear Lens"> Clear Lens</label>
                                <label><input type="checkbox" name="lens_option" value="UV420"> UV420</label>
                                <label><input type="checkbox" name="lens_option" value="Photochromic"> Photochromic</label>
                                <label><input type="checkbox" name="lens_option" value="Transition"> Transition</label>
                                <label><input type="checkbox" name="lens_option" value="Other"> Other</label>
                                <input type="text" name="lens_option_other" class="w-full p-2 border rounded" placeholder="ระบุอื่นๆ">
                            </div>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">Lens Design</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="lens_design" value="Single Vision"> Single Vision</label>
                                <label><input type="checkbox" name="lens_design" value="Bifocal"> Bifocal</label>
                                <label><input type="checkbox" name="lens_design" value="Trifocal"> Trifocal</label>
                                <label><input type="checkbox" name="lens_design" value="Progressive"> Progressive</label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Lens Type</label>
                            <textarea name="lens_type" class="w-full p-2 border rounded" rows="3"></textarea>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">ทำสี (Tint)</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="tint" value="Original"> เดิม</label>
                                <label><input type="checkbox" name="tint" value="Gradient"> ไล่สี</label>
                                <input type="text" name="tint_color" class="w-full p-2 border rounded" placeholder="ระบุสี">
                            </div>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">Treatment (เคลือบ)</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="treatment" value="UC"> UC</label>
                                <label><input type="checkbox" name="treatment" value="HC"> HC</label>
                                <label><input type="checkbox" name="treatment" value="HMC"> HMC</label>
                                <label><input type="checkbox" name="treatment" value="SuperHMC"> SuperHMC</label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">Wear Type</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="wear_type" value="Full Time"> ตลอดเวลา</label>
                                <label><input type="checkbox" name="wear_type" value="Distance"> มองไกล</label>
                                <label><input type="checkbox" name="wear_type" value="Near"> มองใกล้</label>
                                <label><input type="checkbox" name="wear_type" value="Computer"> ระยะคอมพิวเตอร์</label>
                                <label><input type="checkbox" name="wear_type" value="Sunglasses"> กันแดด</label>
                            </div>
                        </div>
                    </div>

                    <!-- Frame Details -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">โครงสร้างแว่น</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">BVD</label><input type="text" name="bvd" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">PTA</label><input type="text" name="pta" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">Wrap</label><input type="text" name="wrap" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">BCL</label><input type="text" name="bcl" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">คาน</label><input type="text" name="frame_bridge" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">สูง</label><input type="text" name="frame_height" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">กว้าง</label><input type="text" name="frame_width" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ทะแยง</label><input type="text" name="frame_diagonal" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="mt-4">
                            <h4 class="text-lg font-medium">ลักษณะเข้ากรอบ</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="frame_type" value="Full"> เต็ม</label>
                                <label><input type="checkbox" name="frame_type" value="Groove"> เซาะ</label>
                                <label><input type="checkbox" name="frame_type" value="Drill"> เจาะ</label>
                            </div>
                        </div>
                    </div>

                    <!-- Order Details -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">รายการแว่น</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm">ยี่ห้อแว่น</label><input type="text" name="frame_brand" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">รุ่น</label><input type="text" name="frame_model" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">หมายเหตุ</label><input type="text" name="notes" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ราคาแว่น</label><input type="number" name="frame_price" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ราคาเลนส์</label><input type="number" name="lens_price" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ส่วนลด</label><input type="number" name="discount" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ยอดรวม</label><input type="number" name="total" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ชำระ</label><input type="number" name="paid" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ผู้ตรวจสายตา</label><input type="text" name="examiner" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ผู้สั่งซื้อ</label><input type="text" name="buyer" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">คงค้าง</label><input type="number" name="outstanding" class="w-full p-2 border rounded"></div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4">
                        <button type="button" id="closeModalBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">ยกเลิก</button>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div><canvas id="genderChart"></canvas></div>
            <div><canvas id="memberTypeChart"></canvas></div>
            <div><canvas id="totalRecordsChart"></canvas></div>
            <div><canvas id="ageRangeChart"></canvas></div>
        </div>

        <!-- Data Table -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-2xl font-bold mb-4">รายการข้อมูลลูกค้า</h2>
            <table class="w-full table-auto">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="px-4 py-2">ชื่อ</th>
                        <th class="px-4 py-2">สกุล</th>
                        <th class="px-4 py-2">เพศ</th>
                        <th class="px-4 py-2">ประเภทสมาชิก</th>
                        <th class="px-4 py-2">การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody id="customerTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Replace 'customer_crud' with the actual function name
        const SUPABASE_FUNCTIONS_URL = 'https://mihtvcbzguzkvfwnlnem.supabase.co/functions/v1/customer-web';
        let genderChart, memberTypeChart, totalRecordsChart, ageRangeChart;

        // Initialize Flatpickr
        flatpickr("#birth_date", {
            dateFormat: "Y-m-d",
            locale: {
                firstDayOfWeek: 1,
                weekdays: { shorthand: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'], longhand: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'] },
                months: { shorthand: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'], longhand: ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'] }
            }
        });

        // Modal control functions
        function openModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            document.getElementById('customerForm').reset();
            document.getElementById('customerForm').onsubmit = handleFormSubmit;
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            document.getElementById('customerForm').reset();
            document.getElementById('customerForm').onsubmit = handleFormSubmit;
        }

        // Enhanced fetch with detailed error handling
        async function makeRequest(payload) {
            try {
                const response = await fetch(SUPABASE_FUNCTIONS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP error ${response.status}: ${response.statusText}. Response: ${text.substring(0, 100)}...`);
                }
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Expected JSON, received ${contentType}: ${text.substring(0, 100)}...`);
                }
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        // Load customer data
        async function loadData() {
            Swal.fire({ title: 'กำลังโหลด...', didOpen: () => Swal.showLoading() });
            try {
                const data = await makeRequest({ method: 'GET' });
                Swal.close();
                displayData(data);
                updateCharts(data);
            } catch (error) {
                Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถโหลดข้อมูล: ${error.message}`, 'error');
                console.error('Load data error:', error);
            }
        }

        // Display data in table
        function displayData(data) {
            const tableBody = document.getElementById('customerTable');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.classList.add('border-b', 'hover:bg-gray-100', 'cursor-pointer');
                tr.innerHTML = `
                    <td class="border px-4 py-2">${item.first_name}</td>
                    <td class="border px-4 py-2">${item.last_name}</td>
                    <td class="border px-4 py-2">${item.gender === 'male' ? 'ชาย' : 'หญิง'}</td>
                    <td class="border px-4 py-2">${Array.isArray(item.member_type) ? item.member_type.join(', ') : item.member_type || ''}</td>
                    <td class="border px-4 py-2">
                        <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-2 rounded">แก้ไข</button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded">ลบ</button>
                    </td>
                `;
                tr.querySelector('.edit-btn').addEventListener('click', () => editCustomer(item.id));
                tr.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCustomer(item.id);
                });
                tableBody.appendChild(tr);
            });
        }

        // Update charts
        function updateCharts(data) {
            const genderCounts = { male: 0, female: 0 };
            const memberCounts = { member: 0, new: 0 };
            const ageRanges = { '0-20': 0, '21-40': 0, '41-60': 0, '61+': 0 };

            data.forEach(item => {
                genderCounts[item.gender]++;
                if (Array.isArray(item.member_type)) {
                    if (item.member_type.includes('member')) memberCounts.member++;
                    if (item.member_type.includes('new')) memberCounts.new++;
                }
                if (item.age <= 20) ageRanges['0-20']++;
                else if (item.age <= 40) ageRanges['21-40']++;
                else if (item.age <= 60) ageRanges['41-60']++;
                else ageRanges['61+']++;
            });

            if (genderChart) genderChart.destroy();
            if (memberTypeChart) memberTypeChart.destroy();
            if (totalRecordsChart) totalRecordsChart.destroy();
            if (ageRangeChart) ageRangeChart.destroy();

            genderChart = new Chart(document.getElementById('genderChart'), {
                type: 'doughnut',
                data: {
                    labels: ['ชาย', 'หญิง'],
                    datasets: [{ data: [genderCounts.male, genderCounts.female], backgroundColor: ['#3B82F6', '#EC4899'] }]
                },
                options: { plugins: { title: { display: true, text: 'สัดส่วนเพศ' } } }
            });

            memberTypeChart = new Chart(document.getElementById('memberTypeChart'), {
                type: 'doughnut',
                data: {
                    labels: ['ลูกค้าสมาชิก', 'ลูกค้าใหม่'],
                    datasets: [{ data: [memberCounts.member, memberCounts.new], backgroundColor: ['#10B981', '#F59E0B'] }]
                },
                options: { plugins: { title: { display: true, text: 'ประเภทสมาชิก' } } }
            });

            totalRecordsChart = new Chart(document.getElementById('totalRecordsChart'), {
                type: 'doughnut',
                data: {
                    labels: ['จำนวนทั้งหมด'],
                    datasets: [{ data: [data.length], backgroundColor: ['#6366F1'] }]
                },
                options: { plugins: { title: { display: true, text: 'จำนวนทั้งหมด' } } }
            });

            ageRangeChart = new Chart(document.getElementById('ageRangeChart'), {
                type: 'doughnut',
                data: {
                    labels: ['0-20', '21-40', '41-60', '61+'],
                    datasets: [{ data: Object.values(ageRanges), backgroundColor: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6'] }]
                },
                options: { plugins: { title: { display: true, text: 'ช่วงอายุ' } } }
            });
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.member_type = formData.getAll('member_type');
            data.frame_type = formData.getAll('frame_type');
            data.material_index = formData.getAll('material_index');
            data.lens_option = formData.getAll('lens_option');
            data.lens_design = formData.getAll('lens_design');
            data.tint = formData.getAll('tint');
            data.treatment = formData.getAll('treatment');
            data.wear_type = formData.getAll('wear_type');

            // Convert numeric fields
            ['age', 'frame_price', 'lens_price', 'discount', 'total', 'paid', 'outstanding'].forEach(key => {
                if (data[key]) data[key] = parseFloat(data[key]);
                else data[key] = null;
            });

            try {
                const result = await makeRequest({ method: 'POST', data });
                Swal.fire('สำเร็จ!', 'บันทึกข้อมูลเรียบร้อย', 'success');
                closeModal();
                loadData();
            } catch (error) {
                Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถบันทึกข้อมูล: ${error.message}`, 'error');
                console.error('Form submission error:', error);
            }
        }

        // Edit customer
        async function editCustomer(id) {
            try {
                const record = await makeRequest({ method: 'GET_BY_ID', id });
                openModal();
                const form = document.getElementById('customerForm');
                Object.entries(record).forEach(([key, value]) => {
                    if (Array.isArray(value)) {
                        value.forEach(val => {
                            const input = form.querySelector(`input[name="${key}"][value="${val}"]`);
                            if (input) input.checked = true;
                        });
                    } else {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) input.value = value || '';
                    }
                });

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });
                    const formData = new FormData(e.target);
                    const updatedData = Object.fromEntries(formData);
                    updatedData.member_type = formData.getAll('member_type');
                    updatedData.frame_type = formData.getAll('frame_type');
                    updatedData.material_index = formData.getAll('material_index');
                    updatedData.lens_option = formData.getAll('lens_option');
                    updatedData.lens_design = formData.getAll('lens_design');
                    updatedData.tint = formData.getAll('tint');
                    updatedData.treatment = formData.getAll('treatment');
                    updatedData.wear_type = formData.getAll('wear_type');

                    // Convert numeric fields
                    ['age', 'frame_price', 'lens_price', 'discount', 'total', 'paid', 'outstanding'].forEach(key => {
                        if (updatedData[key]) updatedData[key] = parseFloat(updatedData[key]);
                        else updatedData[key] = null;
                    });

                    try {
                        const result = await makeRequest({ method: 'PUT', id, data: updatedData });
                        Swal.fire('สำเร็จ!', 'แก้ไขข้อมูลเรียบร้อย', 'success');
                        closeModal();
                        loadData();
                    } catch (error) {
                        Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถแก้ไขข้อมูล: ${error.message}`, 'error');
                        console.error('Edit customer error:', error);
                    }
                };
            } catch (error) {
                Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถโหลดข้อมูลลูกค้า: ${error.message}`, 'error');
                console.error('Edit customer error:', error);
            }
        }

        // Delete customer
        async function deleteCustomer(id) {
            Swal.fire({
                title: 'ยืนยันการลบ?',
                text: 'ข้อมูลนี้จะถูกลบอย่างถาวร',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const result = await makeRequest({ method: 'DELETE', id });
                        Swal.fire('สำเร็จ!', 'ลบข้อมูลเรียบร้อย', 'success');
                        loadData();
                    } catch (error) {
                        Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถลบข้อมูล: ${error.message}`, 'error');
                        console.error('Delete customer error:', error);
                    }
                }
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            // Ensure modal is hidden on page load
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');

            setTimeout(() => {
                document.getElementById('preloader').style.display = 'none';
                loadData();
            }, 1000);

            // Attach event listeners
            document.getElementById('openModalBtn').addEventListener('click', openModal);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('customerForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
</body>
</html>
